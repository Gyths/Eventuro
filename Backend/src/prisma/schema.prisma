// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas = ["public", "app"]
}

// ====================== Enums ======================
enum GENDER {
  M // male
  F // female
  O // other

  @@schema("public")
}

enum STATUS_USER {
  A // active
  S // suspended
  D // deleted

  @@schema("public")
}

enum ID_TYPE {
  RUC
  DNI

  @@schema("public")
}

enum ACCESS_POLICY {
  E // everyone: todo el mundo
  T // teenagers: mayores a 14 con compañia adulta
  AO // adults only: mayores a 18

  @@schema("public")
}

enum EVENT_STATUS {
  P // pending: pendiente
  A // acepted: aceptado
  D // denied: denegado

  @@schema("public")
}

enum ZONE_KIND {
  GENERAL // aforo
  SEATED // asientos numerados

  @@schema("public")
}

enum CURRENCY {
  PEN
  USD

  @@schema("public")
}

enum ORDER_STATUS {
  CREATED
  PENDING_PAYMENT
  PAID
  CANCELLED
  EXPIRED

  @@schema("public")
}

enum SEAT_STATUS {
  AVAILABLE
  HELD
  SOLD

  @@schema("public")
}

enum TICKET_STATUS {
  PAID
  CANCELLED
  USED
  EXPIRED

  @@schema("public")
}

enum REFUND_STATUS {
  NONE
  REQUESTED
  APPROVED
  REJECTED

  @@schema("public")
}

enum DISCOUNT_TYPE {
  CASH
  PERCENTAGE

  @@schema("public")
}

enum DISCOUNT_SCOPE {
  GLOBAL
  EVENT
  USER
  EVENT_USER

  @@schema("public")
}

enum STATUS_DISCOUNT {
  A
  I

  @@schema("public")
}

/**
 * NUEVO: estado del perfil de organizador
 */
enum ORGANIZER_STATUS {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED

  @@schema("public")
}

// ====================== Models ======================

// Usuario general
model User {
  userId    BigInt      @id @default(autoincrement()) @db.BigInt
  name      String
  lastName  String
  phone     String?
  email     String      @unique
  birthdate DateTime?
  gender    GENDER?
  status    STATUS_USER @default(A)

  // Relaciones
  password      PasswordUser?
  oauths        OAuthUser[]
  organizer     Organizer?
  administrator Administrator? // NUEVO: relación 1:1 con Administrator
  Ticket        Ticket[]       @relation("TicketOwner")
  Discount      Discount[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("public")
}

// Usuario con login por contraseña (1:1 con User)
model PasswordUser {
  userId         BigInt @id @db.BigInt
  hashedPassword String

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@schema("public")
}

// Usuario con login externo OAuth (Google, etc.)
model OAuthUser {
  id             Int    @id @default(autoincrement())
  userId         BigInt @db.BigInt
  provider       String
  providerUserId String

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@index([userId])

  @@schema("public")
}

/**
 * NUEVO: perfil de administrador (1:1 con User)
 */
model Administrator {
  administratorId BigInt @id @default(autoincrement()) @db.BigInt
  userId          BigInt @unique @db.BigInt

  //Relaciones
  auditLogs AuditLog[]

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@schema("public")
}

// Organizador (1:1 con User)
model Organizer {
  organizerId BigInt           @id @default(autoincrement()) @db.BigInt
  userId      BigInt           @unique @db.BigInt
  companyName String
  idType      ID_TYPE
  idNumber    String           @unique
  status      ORGANIZER_STATUS @default(DRAFT) // NUEVO

  user   User    @relation(fields: [userId], references: [userId], onDelete: Cascade)
  events Event[]

  @@schema("public")
}

// Categorías de un evento
model EventCategory {
  eventCategoryId BigInt @id @default(autoincrement()) @db.BigInt
  initials        String @unique
  description     String

  // relaciones
  events EventToCategory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("public")
}

// Tabla intermedia entre Evento y Categorías
model EventToCategory {
  eventId         BigInt @db.BigInt
  eventCategoryId BigInt @db.BigInt

  // relaciones
  event    Event         @relation(fields: [eventId], references: [eventId], onDelete: Cascade)
  category EventCategory @relation(fields: [eventCategoryId], references: [eventCategoryId], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([eventId, eventCategoryId])

  @@schema("public")
}

// Local de un evento
model Venue {
  venueId    BigInt  @id @default(autoincrement()) @db.BigInt
  eventId    BigInt  @unique @db.BigInt
  city       String?
  address    String?
  addressUrl String?
  reference  String?
  capacity   Int

  // relación
  event Event @relation("EventVenue", fields: [eventId], references: [eventId], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("public")
}

// Tarifa
model Fee {
  feeId      BigInt  @id @default(autoincrement()) @db.BigInt
  percentage Decimal @db.Decimal(10, 2)

  // relación
  event Event[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("public")
}

// Evento
model Event {
  eventId                 BigInt        @id @default(autoincrement()) @db.BigInt
  organizerId             BigInt        @db.BigInt
  feeId                   BigInt?       @db.BigInt
  title                   String
  imagePrincipalKey       String
  imageBannerKey          String
  status                  EVENT_STATUS  @default(A)
  inPerson                Boolean
  description             String
  accessPolicy            ACCESS_POLICY
  accessPolicyDescription String?

  // Relaciones
  organizer   Organizer         @relation(fields: [organizerId], references: [organizerId])
  venue       Venue?            @relation("EventVenue")
  fee         Fee?              @relation(fields: [feeId], references: [feeId], onDelete: SetNull)
  categories  EventToCategory[]
  dates       EventDate[]
  salesPhases EventSalesPhase[]
  Discount    Discount[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizerId])
  @@index([feeId])
  @@index([title])

  @@schema("public")
}

model EventDate {
  eventDateId BigInt   @id @default(autoincrement()) @db.BigInt
  eventId     BigInt   @db.BigInt
  startAt     DateTime
  endAt       DateTime

  // relaciones
  event     Event           @relation(fields: [eventId], references: [eventId], onDelete: Cascade)
  zoneDates EventDateZone[]
  OrderItem OrderItem[]
  Ticket    Ticket[]
  Hold      Hold[]

  @@index([eventId, startAt])

  @@schema("public")
}

model EventDateZone {
  eventDateZoneId   BigInt    @id @default(autoincrement()) @db.BigInt
  eventDateId       BigInt    @db.BigInt
  name              String
  kind              ZONE_KIND
  basePrice         Decimal   @db.Decimal(10, 2)
  capacity          Int
  capacityRemaining Int
  seatMapId         BigInt?   @unique @db.BigInt
  currency          CURRENCY

  // relaciones
  eventDate   EventDate                 @relation(fields: [eventDateId], references: [eventDateId], onDelete: Cascade)
  seatMap     SeatMap?                  @relation(fields: [seatMapId], references: [seatMapId], onDelete: SetNull)
  allocations EventDateZoneAllocation[]
  OrderItem   OrderItem[]
  Ticket      Ticket[]
  Hold        Hold[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventDateId, name])

  @@schema("public")
}

model SeatMap {
  seatMapId BigInt @id @default(autoincrement()) @db.BigInt
  rows      Int
  cols      Int

  // relaciones
  occupiedSeats Seat[]
  EventDateZone EventDateZone?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("public")
}

model Seat {
  seatId    BigInt      @id @default(autoincrement()) @db.BigInt
  seatMapId BigInt      @db.BigInt
  rowNumber Int
  colNumber Int
  status    SEAT_STATUS @default(AVAILABLE)
  holdUntil DateTime?

  // relaciones
  seatMap   SeatMap     @relation(fields: [seatMapId], references: [seatMapId], onDelete: Cascade)
  OrderItem OrderItem[]
  Ticket    Ticket[]
  Hold      Hold[]

  @@unique([seatMapId, rowNumber, colNumber])
  @@index([seatMapId])
  @@index([status])

  @@schema("public")
}

model EventDateZoneAllocation {
  eventDateZoneAllocationId BigInt        @id @default(autoincrement()) @db.BigInt
  eventDateZoneId           BigInt        @db.BigInt
  audienceName              String
  discountType              DISCOUNT_TYPE
  discountValue             Decimal       @db.Decimal(5, 2)
  allocatedQuantity         Int?
  remainingQuantity         Int?

  // relaciones
  zone      EventDateZone @relation(fields: [eventDateZoneId], references: [eventDateZoneId], onDelete: Cascade)
  OrderItem OrderItem[]
  Ticket    Ticket[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventDateZoneId, audienceName])

  @@schema("public")
}

// Fases de venta
model EventSalesPhase {
  eventSalesPhaseId BigInt    @id @default(autoincrement()) @db.BigInt
  eventId           BigInt    @db.BigInt
  name              String
  startAt           DateTime?
  endAt             DateTime?
  ticketLimit       Int?
  percentage        Decimal   @db.Decimal(10, 2)
  active            Boolean   @default(false)

  event Event @relation(fields: [eventId], references: [eventId], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventId, startAt])

  @@schema("public")
}

model Order {
  orderId     BigInt       @id @default(autoincrement()) @db.BigInt
  buyerUserId BigInt       @db.BigInt
  status      ORDER_STATUS @default(CREATED)
  currency    CURRENCY
  totalAmount Decimal      @db.Decimal(10, 2)

  // Relaciones
  items OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([buyerUserId])
  @@index([status, createdAt])

  @@schema("public")
}

model OrderItem {
  orderItemId               BigInt   @id @default(autoincrement()) @db.BigInt
  orderId                   BigInt   @db.BigInt
  eventId                   BigInt   @db.BigInt
  eventDateId               BigInt   @db.BigInt
  eventDateZoneId           BigInt   @db.BigInt
  eventDateZoneAllocationId BigInt?  @db.BigInt
  quantity                  Int?
  seatId                    BigInt?  @db.BigInt
  unitPrice                 Decimal  @db.Decimal(10, 2)
  discountAmount            Decimal? @db.Decimal(10, 2)
  finalPrice                Decimal  @db.Decimal(10, 2)

  // Relaciones
  order      Order                    @relation(fields: [orderId], references: [orderId], onDelete: Cascade)
  eventDate  EventDate                @relation(fields: [eventDateId], references: [eventDateId], onDelete: Restrict)
  zone       EventDateZone            @relation(fields: [eventDateZoneId], references: [eventDateZoneId], onDelete: Restrict)
  seat       Seat?                    @relation(fields: [seatId], references: [seatId], onDelete: Restrict)
  allocation EventDateZoneAllocation? @relation(fields: [eventDateZoneAllocationId], references: [eventDateZoneAllocationId], onDelete: SetNull)
  Ticket     Ticket[]

  @@unique([seatId])
  @@index([orderId])
  @@index([eventDateId, eventDateZoneId])

  @@schema("public")
}

model Ticket {
  ticketId                  BigInt        @id @default(autoincrement()) @db.BigInt
  ownerUserId               BigInt?       @db.BigInt
  orderItemId               BigInt        @db.BigInt
  eventId                   BigInt        @db.BigInt
  eventDateId               BigInt        @db.BigInt
  eventDateZoneId           BigInt        @db.BigInt
  eventDateZoneAllocationId BigInt?       @db.BigInt
  seatId                    BigInt?       @db.BigInt
  pricePaid                 Decimal       @db.Decimal(10, 2)
  currency                  CURRENCY      @default(PEN)
  issuedAt                  DateTime      @default(now())
  status                    TICKET_STATUS @default(PAID)

  refundStatus      REFUND_STATUS @default(NONE)
  refundRequestedAt DateTime?

  item       OrderItem                @relation(fields: [orderItemId], references: [orderItemId], onDelete: Restrict)
  eventDate  EventDate                @relation(fields: [eventDateId], references: [eventDateId], onDelete: Restrict)
  zone       EventDateZone            @relation(fields: [eventDateZoneId], references: [eventDateZoneId], onDelete: Restrict)
  seat       Seat?                    @relation(fields: [seatId], references: [seatId], onDelete: Restrict)
  allocation EventDateZoneAllocation? @relation(fields: [eventDateZoneAllocationId], references: [eventDateZoneAllocationId], onDelete: SetNull)
  owner      User?                    @relation("TicketOwner", fields: [ownerUserId], references: [userId], onDelete: SetNull)

  @@unique([eventDateId, seatId])
  @@index([eventDateId, eventDateZoneId])

  @@schema("public")
}

model Hold {
  holdId          BigInt   @id @default(autoincrement()) @db.BigInt
  eventDateId     BigInt   @db.BigInt
  eventDateZoneId BigInt   @db.BigInt
  seatId          BigInt?  @db.BigInt
  quantity        Int?
  buyerUserId     BigInt?  @db.BigInt
  expiresAt       DateTime
  createdAt       DateTime @default(now())

  eventDate EventDate     @relation(fields: [eventDateId], references: [eventDateId], onDelete: Cascade)
  zone      EventDateZone @relation(fields: [eventDateZoneId], references: [eventDateZoneId], onDelete: Cascade)
  seat      Seat?         @relation(fields: [seatId], references: [seatId], onDelete: Restrict)

  @@unique([seatId])
  @@index([eventDateId, eventDateZoneId])
  @@index([expiresAt])

  @@schema("public")
}

model AuditLog {
  auditLogId      BigInt   @id @default(autoincrement()) @db.BigInt
  administratorId BigInt?  @db.BigInt // relación directa a Administrator                   
  entityName      String // Ej: "Event", "Ticket", "User", etc.
  entityId        BigInt?  @db.BigInt
  action          String // "CREATE", "UPDATE", "DELETE"
  description     String?
  createdAt       DateTime @default(now())

  administrator Administrator? @relation(fields: [administratorId], references: [administratorId], onDelete: SetNull)

  @@index([administratorId])
  @@index([entityName, action])
  @@index([createdAt])

  @@schema("public")
}

model Discount {
  discountId   BigInt          @id @default(autoincrement()) @db.BigInt
  scope        DISCOUNT_SCOPE
  eventId      BigInt?         @db.BigInt
  userId       BigInt?         @db.BigInt
  code         String
  percentage   Decimal         @db.Decimal(5, 2)
  stackable    Boolean         @default(false)
  startAt      DateTime
  endAt        DateTime
  status       STATUS_DISCOUNT @default(A)
  availableQty Int?
  appliesTo    String?

  // Relaciones
  event Event? @relation(fields: [eventId], references: [eventId], onDelete: Cascade)
  user  User?  @relation(fields: [userId], references: [userId], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([code, scope, eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@index([startAt, endAt])

  @@schema("public")
}

model AuditTransaction {
  auditTransactionId BigInt   @id @default(autoincrement())
  targetTableName    String
  operationType      String
  primaryKeyJson     Json?
  actorUserId        BigInt?
  actorIpAddress     String?
  createdAt          DateTime @default(now())

  //Relaciones
  changes AuditChange[]

  @@map("AuditTransaction")
  @@schema("app")
}

model AuditChange {
  auditChangeId      BigInt   @id @default(autoincrement())
  auditTransactionId BigInt
  columnName         String
  oldValueJson       Json?
  newValueJson       Json?
  isChanged          Boolean?

  //Relaciones
  transaction AuditTransaction @relation(fields: [auditTransactionId], references: [auditTransactionId], onDelete: Cascade)

  @@map("AuditChange")
  @@schema("app")
}
